<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ExpenseWise - Controle de Despesas Pessoais</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    /* ===== DESIGN SYSTEM ===== */
    :root {
      --primary: 234 89% 74%;
      --primary-dark: 234 89% 64%;
      --accent: 142 71% 45%;
      --destructive: 0 84% 60%;

      --background: 240 10% 3.9%;
      --background-light: 240 3.7% 15.9%;
      --surface: 240 5.9% 10%;
      --surface-hover: 240 3.7% 15.9%;

      --text-primary: 0 0% 98%;
      --text-secondary: 240 5% 64.9%;
      --text-muted: 240 3.8% 46.1%;
      --border: 240 3.7% 15.9%;
      --border-light: 240 5% 26%;

      --gradient-primary: linear-gradient(135deg, hsl(var(--primary)), hsl(var(--primary-dark)));
      --gradient-surface: linear-gradient(145deg, hsl(var(--surface)), hsl(var(--background-light)));
    }

    body {
      font-family: 'Inter', sans-serif;
      background: hsl(var(--background));
      color: hsl(var(--text-primary));
      margin: 0;
    }

    /* Header */
    .header {
      background: var(--gradient-primary);
      padding: 1rem;
      text-align: center;
    }
    .header h1 { color: white; display: flex; justify-content: center; gap: .5rem; }

    /* Layout */
    .main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem 1rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 2rem;
    }

    /* Card */
    .card {
      background: var(--gradient-surface);
      border: 1px solid hsl(var(--border));
      border-radius: .75rem;
      padding: 1.5rem;
    }
    .card-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; display: flex; gap: .5rem; }

    /* Inputs */
    .form { display: flex; flex-direction: column; gap: 1rem; }
    .form-group { display: flex; flex-direction: column; gap: .25rem; }
    .label { font-size: .875rem; color: hsl(var(--text-secondary)); }
    .input, .select {
      padding: .5rem;
      border: 1px solid hsl(var(--border));
      border-radius: .5rem;
      background: hsl(var(--surface));
      color: white;
    }

    /* Buttons */
    .btn { padding: .5rem 1rem; border: none; border-radius: .5rem; cursor: pointer; display: inline-flex; align-items: center; gap: .25rem; }
    .btn-primary { background: var(--gradient-primary); color: white; }
    .btn-secondary { background: hsl(var(--surface-hover)); color: white; }
    .btn-edit { background: hsl(var(--accent)); color: white; }
    .btn-delete { background: hsl(var(--destructive)); color: white; }
    .btn-small { font-size: .75rem; padding: .25rem .5rem; }

    /* Table */
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: .5rem; border-bottom: 1px solid hsl(var(--border)); }
    th { background: hsl(var(--surface-hover)); text-align: left; }

    /* Chart */
    .chart-container { height: 400px; }

    /* ===== DASHBOARD (corrigido) ===== */

/* grid que organiza os cards das métricas */
.stats-grid{
  display:grid;
  grid-template-columns: repeat(4, minmax(180px,1fr));
  gap: 1rem;                 /* espaço entre os cards */
  margin-bottom: 1.25rem;
}

/* responsivo */
@media (max-width: 1200px){
  .stats-grid{ grid-template-columns: repeat(3,1fr); }
}
@media (max-width: 900px){
  .stats-grid{ grid-template-columns: repeat(2,1fr); }
}
@media (max-width: 520px){
  .stats-grid{ grid-template-columns: 1fr; }
}

/* cada cartão da métrica */
.stat-card{
  background: hsl(var(--surface-hover));
  border: 1px solid hsl(var(--border));
  border-radius: 12px;
  padding: 16px 20px;
  box-shadow: var(--shadow-sm);
  transition: transform .2s ease, border-color .2s ease, box-shadow .2s ease;
}
.stat-card:hover{
  transform: translateY(-2px);
  border-color: hsl(var(--primary) / .35);
  box-shadow: var(--shadow-md), 0 0 0 3px hsl(var(--primary) / .08);
}

/* valor em destaque */
.stat-value{
  font-size: clamp(1.25rem, 3vw, 1.75rem);
  font-weight: 700;
  color: hsl(var(--primary));
  line-height: 1.2;
}

/* legenda abaixo do valor */
.stat-label{
  margin-top: 4px;
  font-size: .875rem;
  color: hsl(var(--text-secondary));
  letter-spacing: .2px;
}

  </style>
</head>
<body>
  <header class="header">
    <h1><i data-lucide="wallet"></i> ExpenseWise</h1>
  </header>

  <main class="main">

      <!-- ===== DASHBOARD STATS ===== -->
      <section class="card" style="grid-column: 1 / -1;">
        <h2 class="card-title">
          <i data-lucide="bar-chart-3"></i>
          Dashboard
        </h2>
        <div class="stats-grid" id="statsGrid">
          <div class="stat-card">
            <div class="stat-value" id="totalGastos">R$ 0,00</div>
            <div class="stat-label">Total de Gastos</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalCategorias">0</div>
            <div class="stat-label">Categorias</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="gastosEsteMes">R$ 0,00</div>
            <div class="stat-label">Gastos Este Mês</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="maiorGasto">R$ 0,00</div>
            <div class="stat-label">Maior Gasto</div>
          </div>
        </div>
      </section>



    <!-- Adicionar Despesa -->
    <section class="card">
      <h2 class="card-title"><i data-lucide="plus-circle"></i> Adicionar Despesa</h2>
      <form id="formDespesas" class="form">
        <div class="form-group"><label class="label">Data</label><input type="date" id="data" class="input" required></div>
        <div class="form-group"><label class="label">Categoria</label><select id="categoria" class="select" required></select></div>
        <div class="form-group"><label class="label">Valor</label><input type="number" id="valor" class="input" step="0.01" required></div>
        <div class="form-group"><label class="label">Observação</label><input type="text" id="obs" class="input"></div>
        <div class="form-group"><label class="label">Status</label>
          <select id="pago" class="select"><option value="true">✅ Pago</option><option value="false">⏳ Pendente</option></select>
        </div>
        <button type="submit" class="btn btn-primary"><i data-lucide="plus"></i> Salvar</button>
      </form>
    </section>

    <!-- Nova Categoria -->
    <section class="card">
      <h2 class="card-title"><i data-lucide="tag"></i> Nova Categoria</h2>
      <form id="formCategorias" class="form">
        <div class="form-group"><input type="text" id="nomeCategoria" class="input" placeholder="Ex: Transporte" required></div>
        <button type="submit" class="btn btn-primary"><i data-lucide="tag"></i> Criar</button>
      </form>
    </section>

    <!-- Relatórios -->
    <section class="card">
      <h2 class="card-title"><i data-lucide="file-text"></i> Relatórios</h2>
      <form class="form">
        <div class="form-group"><label>Categoria</label><select id="relatorioCategoria" class="select"></select></div>
        <div class="form-group"><label>Ano</label><select id="relatorioAno" class="select"><option value="">Todos</option></select></div>
        <div class="form-group"><label>Mês</label>
          <select id="relatorioMes" class="select">
            <option value="">Todos</option><option value="1">Janeiro</option><option value="2">Fevereiro</option><option value="3">Março</option>
            <option value="4">Abril</option><option value="5">Maio</option><option value="6">Junho</option><option value="7">Julho</option>
            <option value="8">Agosto</option><option value="9">Setembro</option><option value="10">Outubro</option>
            <option value="11">Novembro</option><option value="12">Dezembro</option>
          </select>
        </div>
        <button type="button" id="btnRelatorio" class="btn btn-secondary"><i data-lucide="search"></i> Gerar</button>
      </form>
      <div id="resultadoRelatorio" style="margin-top:1rem; font-size:.9rem; color:hsl(var(--text-secondary));"></div>
    </section>

    <!-- Gráfico -->
    <section class="card" style="grid-column: 1 / -1;">
      <h2 class="card-title"><i data-lucide="pie-chart"></i> Gastos por Categoria</h2>
      <div class="form-group"><label>Tipo de Gráfico</label>
        <select id="tipoGrafico" class="select"><option value="doughnut">Rosca</option><option value="pie">Pizza</option><option value="bar">Barras</option></select>
      </div>
      <div class="chart-container"><canvas id="graficoGastos"></canvas></div>
    </section>


    <!-- ===== FILTRO DE DESPESAS ===== -->
<section class="card" style="grid-column: 1 / -1;">
  <h2 class="card-title">
    <i data-lucide="filter"></i>
    Filtrar Despesas
  </h2>
  <form id="formFiltro" class="form">
    <div class="form-group">
      <label class="label" for="filtroCategoria">Categoria:</label>
      <select id="filtroCategoria" class="select">
        <option value="">Todas</option>
      </select>
    </div>

    <div class="form-group">
      <label class="label" for="filtroAno">Ano:</label>
      <select id="filtroAno" class="select">
        <option value="">Todos</option>
      </select>
    </div>

    <div class="form-group">
      <label class="label" for="filtroMes">Mês:</label>
      <select id="filtroMes" class="select">
        <option value="">Todos</option>
        <option value="1">Janeiro</option>
        <option value="2">Fevereiro</option>
        <option value="3">Março</option>
        <option value="4">Abril</option>
        <option value="5">Maio</option>
        <option value="6">Junho</option>
        <option value="7">Julho</option>
        <option value="8">Agosto</option>
        <option value="9">Setembro</option>
        <option value="10">Outubro</option>
        <option value="11">Novembro</option>
        <option value="12">Dezembro</option>
      </select>
    </div>

    <button type="submit" class="btn btn-primary">
      <i data-lucide="search"></i> Buscar
    </button>
  </form>
</section>

    <!-- Lista -->
    <section class="card" style="grid-column: 1 / -1;">
      <h2 class="card-title"><i data-lucide="list"></i> Minhas Despesas</h2>
      <div class="table-container">
        <table><thead><tr><th>Data</th><th>Categoria</th><th>Valor</th><th>Status</th><th>Ações</th></tr></thead>
          <tbody id="listaDespesas"></tbody>
        </table>
      </div>
    </section>
  </main>
<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// ================== SUPABASE ==================
const supabase = createClient(
  "https://dylziaqkyavkfwjepqkp.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5bHppYXFreWF2a2Z3amVwcWtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0NTc1OTgsImV4cCI6MjA2ODAzMzU5OH0.gy5jXxKOTgeCf0Rwq7ktLTz1pyoZ8dJjZOK9UB9rHCM"
);

// ================== ELEMENTOS ==================
const formDespesas = document.getElementById("formDespesas");
const formCategorias = document.getElementById("formCategorias");
const categoriaSelect = document.getElementById("categoria");
const relatorioCategoria = document.getElementById("relatorioCategoria");
const relatorioAno = document.getElementById("relatorioAno");
const relatorioMes = document.getElementById("relatorioMes");
const resultadoRelatorio = document.getElementById("resultadoRelatorio");
const listaDespesas = document.getElementById("listaDespesas");
const formFiltro = document.getElementById("formFiltro");
const tabelaSection = document.getElementById("tabelaSection");
let chart, editandoId = null;

// ================== HELPERS ==================
const BRL = v => new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(v);
function initIcons(){ if(window.lucide) lucide.createIcons(); }

// ================== CATEGORIAS ==================
async function carregarCategorias(){
  const { data, error } = await supabase.from("tipo_despesas").select("*");
  if(error) return console.error(error);
  const options = data.map(c=>`<option value="${c.id}">${c.nome}</option>`).join("");
  categoriaSelect.innerHTML = '<option value="">Selecione...</option>'+options;
  relatorioCategoria.innerHTML = '<option value="">Todas</option>'+options;

  // Também preencher o filtro
  const filtroCat = document.getElementById("filtroCategoria");
  if (filtroCat) {
    filtroCat.innerHTML = '<option value="">Todas</option>'+options;
  }
}

// ================== ESTATÍSTICAS ==================
async function carregarEstatisticas(){
  const { data, error } = await supabase.from("despesas_pessoais").select("valor,data");
  if(error) return;
  const total = data.reduce((s,d)=>s+d.valor,0);
  const hoje=new Date();
  const esteMes=data.filter(d=>{
    const dt=new Date(d.data);
    return dt.getMonth()===hoje.getMonth()&&dt.getFullYear()===hoje.getFullYear()
  }).reduce((s,d)=>s+d.valor,0);
  const maior=data.length?Math.max(...data.map(d=>d.valor)):0;
  document.getElementById("totalGastos").textContent=BRL(total);
  document.getElementById("gastosEsteMes").textContent=BRL(esteMes);
  document.getElementById("maiorGasto").textContent=BRL(maior);
  const {data:cats}=await supabase.from("tipo_despesas").select("*");
  document.getElementById("totalCategorias").textContent=cats?.length||0;
}

// ================== RELATÓRIO ==================
document.getElementById("btnRelatorio").addEventListener("click", async()=>{
  const idCat=relatorioCategoria.value, ano=relatorioAno.value, mes=relatorioMes.value;
  let query=supabase.from("despesas_pessoais").select("valor,data,tipo_despesas(nome)");
  if(idCat) query=query.eq("tipo_id",idCat);
  if(ano) query=query.gte("data",`${ano}-01-01`).lte("data",`${ano}-12-31`);
  if(mes){
    const a=ano||new Date().getFullYear();
    const m=mes.padStart(2,"0");
    const ultimo=new Date(a,mes,0).getDate();
    query=query.gte("data",`${a}-${m}-01`).lte("data",`${a}-${m}-${ultimo}`);
  }
  const {data,error}=await query; if(error) return;
  const total=data.reduce((s,d)=>s+d.valor,0);
  resultadoRelatorio.innerHTML=`<b>Total:</b> ${BRL(total)} (${data.length} despesas)`;
});

// ================== CARREGAR ANOS ==================
async function carregarAnos() {
  const { data, error } = await supabase.from("despesas_pessoais").select("data");
  if (error) return console.error(error);
  const anos = [...new Set(data.map(d => new Date(d.data).getFullYear()))].sort((a, b) => b - a);

  relatorioAno.innerHTML = '<option value="">Todos os anos</option>';
  anos.forEach(ano => relatorioAno.innerHTML += `<option value="${ano}">${ano}</option>`);

  const filtroAno = document.getElementById("filtroAno");
  if (filtroAno) {
    filtroAno.innerHTML = '<option value="">Todos</option>';
    anos.forEach(ano => filtroAno.innerHTML += `<option value="${ano}">${ano}</option>`);
  }
}

// ================== LISTAR DESPESAS ==================
async function carregarDespesas(filtro = {}) {
  let query = supabase
    .from("despesas_pessoais")
    .select("id,data,valor,obs,pago,tipo_id,tipo_despesas(nome)")
    .order("data", { ascending: false });

  if (filtro.cat) query = query.eq("tipo_id", filtro.cat);
  if (filtro.ano) query = query.gte("data", `${filtro.ano}-01-01`).lte("data", `${filtro.ano}-12-31`);
  if (filtro.mes) {
    const anoFiltro = filtro.ano || new Date().getFullYear();
    const mesFormatado = filtro.mes.padStart(2, "0");
    const ultimoDia = new Date(anoFiltro, filtro.mes, 0).getDate();
    query = query
      .gte("data", `${anoFiltro}-${mesFormatado}-01`)
      .lte("data", `${anoFiltro}-${mesFormatado}-${ultimoDia}`);
  }

  const { data, error } = await query;
  if (error) return console.error(error);

  listaDespesas.innerHTML = "";
  if (!data.length) {
    listaDespesas.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:10px;">Nenhuma despesa encontrada</td></tr>`;
    return;
  }

  data.forEach(d => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${new Date(d.data).toLocaleDateString()}</td>
      <td>${d.tipo_despesas?.nome || "—"}</td>
      <td>${BRL(d.valor)}</td>
      <td>${d.pago ? "✅ Pago" : "⏳ Pendente"}</td>
      <td>
        <button class="btn btn-small btn-edit" onclick="editarDespesa(${d.id},'${d.data}',${d.valor},'${d.obs}',${d.pago},${d.tipo_id})">Editar</button>
        <button class="btn btn-small btn-delete" onclick="excluirDespesa(${d.id})">Excluir</button>
      </td>`;
    listaDespesas.appendChild(tr);
  });
}

// ================== FILTRO DE DESPESAS ==================
formFiltro.addEventListener("submit", async (e) => {
  e.preventDefault();
  const cat = document.getElementById("filtroCategoria").value;
  const ano = document.getElementById("filtroAno").value;
  const mes = document.getElementById("filtroMes").value;

  await carregarDespesas({ cat, ano, mes });
  tabelaSection.classList.remove("hidden");
});

// ================== CRUD DESPESAS ==================
formDespesas.addEventListener("submit",async e=>{
  e.preventDefault();
  const desp={
    data:document.getElementById("data").value,
    valor:+document.getElementById("valor").value,
    obs:document.getElementById("obs").value,
    pago:document.getElementById("pago").value==="true",
    tipo_id:+categoriaSelect.value
  };
  let r;
  if(editandoId){
    r=await supabase.from("despesas_pessoais").update(desp).eq("id",editandoId);
    editandoId=null;
  } else {
    r=await supabase.from("despesas_pessoais").insert([desp]);
  }
  if(r.error) alert(r.error.message);
  else {
    formDespesas.reset();
    carregarDespesas();
    carregarEstatisticas();
    montarGrafico();
  }
});

// ================== CRUD CATEGORIAS ==================
formCategorias.addEventListener("submit",async e=>{
  e.preventDefault();
  const nome=document.getElementById("nomeCategoria").value.trim();
  if(!nome) return;
  const {error}=await supabase.from("tipo_despesas").insert([{nome}]);
  if(error) alert(error.message);
  else {
    formCategorias.reset();
    carregarCategorias();
  }
});

// ================== FUNÇÕES GLOBAIS ==================
window.editarDespesa=(id,data,valor,obs,pago,tipoId)=>{
  editandoId=id;
  document.getElementById("data").value=data.split("T")[0];
  document.getElementById("valor").value=valor;
  document.getElementById("obs").value=obs;
  document.getElementById("pago").value=pago?"true":"false";
  document.getElementById("categoria").value=tipoId;
};
window.excluirDespesa=async(id)=>{
  if(confirm("Excluir?")){
    const{error}=await supabase.from("despesas_pessoais").delete().eq("id",id);
    if(!error){carregarDespesas();carregarEstatisticas();montarGrafico();}
  }
};

// ================== GRÁFICO ==================
async function montarGrafico(){
  const {data,error}=await supabase.from("despesas_pessoais").select("valor,tipo_despesas(nome)");
  if(error) return;
  const dataset={};
  data.forEach(d=>{
    const n=d.tipo_despesas?.nome||"Outros";
    dataset[n]=(dataset[n]||0)+d.valor;
  });
  const ctx=document.getElementById("graficoGastos").getContext("2d");
  if(chart) chart.destroy();
  const tipo=document.getElementById("tipoGrafico").value;
  chart=new Chart(ctx,{
    type:tipo,
    data:{labels:Object.keys(dataset),datasets:[{data:Object.values(dataset)}]},
    options:{responsive:true}
  });
}
document.getElementById("tipoGrafico").addEventListener("change",montarGrafico);

// ================== INIT ==================
document.getElementById("data").value=new Date().toISOString().split("T")[0];
(async()=>{
  initIcons();
  await carregarCategorias();
  await carregarDespesas();
  await carregarEstatisticas();
  await carregarAnos();
  await montarGrafico();
})();
</script>



</body>
</html>

