<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ExpenseWise - Controle de Despesas Pessoais</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    /* ===== DESIGN SYSTEM ===== */
    :root {
  --primary: 280 100% 65%;        /* Roxo neon */
  --primary-dark: 280 100% 55%;
  --secondary: 195 100% 50%;      /* Azul neon */
  --accent: 160 100% 45%;         /* Verde neon */
  --destructive: 0 100% 60%;      /* Vermelho vivo */

  --background: 240 10% 5%;       /* Preto azulado */
  --background-light: 240 10% 10%;
  --surface: 240 10% 12%;
  --surface-hover: 240 10% 16%;

  --text-primary: 0 0% 100%;      /* Branco */
  --text-secondary: 280 100% 80%;  /* Roxo claro */
  --text-muted: 240 10% 60%;      /* Cinza claro */

  --border: 280 100% 40%;         /* Roxo forte */
  --border-light: 280 60% 60%;
}

    }

    body {
      font-family: 'Inter', sans-serif;
      background: hsl(var(--background));
      color: hsl(var(--text-primary));
      margin: 0;
    }

    /* ===== HEADER PRINCIPAL ===== */
.header {
  background: linear-gradient(135deg, hsl(var(--primary)), hsl(var(--primary-dark)));
  color: white;
  text-align: center;
  padding: 2rem 1rem;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 4px 12px hsl(var(--primary) / 0.4);
}

.header h1 {
  font-size: clamp(1.5rem, 4vw, 2.2rem);
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.75rem;
}

.header h1 i {
  width: 28px;
  height: 28px;
  color: white;
  filter: drop-shadow(0 0 8px hsl(var(--primary) / 0.7));
}

    /* Layout */
    .main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem 1rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 2rem;
    }

    /* Card */
    .card {
      background: var(--gradient-surface);
      border: 1px solid hsl(var(--border));
      border-radius: .75rem;
      padding: 1.5rem;
    }
    .card-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; display: flex; gap: .5rem; }

    /* Inputs */
    .form { display: flex; flex-direction: column; gap: 1rem; }
    .form-group { display: flex; flex-direction: column; gap: .25rem; }
    .label { font-size: .875rem; color: hsl(var(--text-secondary)); }
    .input, .select {
      padding: .5rem;
      border: 1px solid hsl(var(--border));
      border-radius: .5rem;
      background: hsl(var(--surface));
      color: white;
    }

    /* Buttons */
    .btn { padding: .5rem 1rem; border: none; border-radius: .5rem; cursor: pointer; display: inline-flex; align-items: center; gap: .25rem; }
    .btn-primary { background: var(--gradient-primary); color: red; }
    .btn-secondary { background: hsl(var(--surface-hover)); color: red; }


    .btn-edit { background: hsl(var(--accent)); color: white; }
    .btn-delete { background: hsl(var(--destructive)); color: white; }
    .btn-small { font-size: .75rem; padding: .25rem .5rem; }



    /* Table */
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: .5rem; border-bottom: 1px solid hsl(var(--border)); }
    th { background: hsl(var(--surface-hover)); text-align: left; }

    /* Chart */
    .chart-container { height: 400px; }

    /* ===== DASHBOARD (corrigido) ===== */

/* grid que organiza os cards das métricas */
.stats-grid{
  display:grid;
  grid-template-columns: repeat(4, minmax(180px,1fr));
  gap: 1rem;                 /* espaço entre os cards */
  margin-bottom: 1.25rem;
}

/* responsivo */
@media (max-width: 1200px){
  .stats-grid{ grid-template-columns: repeat(3,1fr); }
}
@media (max-width: 900px){
  .stats-grid{ grid-template-columns: repeat(2,1fr); }
}
@media (max-width: 520px){
  .stats-grid{ grid-template-columns: 1fr; }
}

/* cada cartão da métrica */
.stat-card{
  background: hsl(var(--surface-hover));
  border: 1px solid hsl(var(--border));
  border-radius: 12px;
  padding: 16px 20px;
  box-shadow: var(--shadow-sm);
  transition: transform .2s ease, border-color .2s ease, box-shadow .2s ease;
}
.stat-card:hover{
  transform: translateY(-2px);
  border-color: hsl(var(--primary) / .35);
  box-shadow: var(--shadow-md), 0 0 0 3px hsl(var(--primary) / .08);
}

/* valor em destaque */
.stat-value{
  font-size: clamp(1.25rem, 3vw, 1.75rem);
  font-weight: 700;
  color: hsl(var(--primary));
  line-height: 1.2;
}

/* legenda abaixo do valor */
.stat-label{
  margin-top: 4px;
  font-size: .875rem;
  color: hsl(var(--text-secondary));
  letter-spacing: .2px;
}

    .chart-container {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 400px; /* mantém responsivo */
  margin-top: var(--spacing-lg);
}


    /* Relatório Resultado Moderno e Grande */
.relatorio-card {
  margin-top: 2rem;
  padding: 2rem 2.5rem; /* mais espaçamento interno */
  border-radius: 18px;  /* cantos mais arredondados */
  background: linear-gradient(135deg, #ff00cc, #3333ff, #00f0ff);
  background-size: 200% 200%;
  color: #fff;
  font-size: 1.5rem;  /* texto maior */
  font-weight: 800;
  text-align: center;
  box-shadow: 0 12px 30px rgba(0,0,0,0.6), 0 0 20px rgba(255,0,255,0.6);
  animation: gradientFlow 6s ease infinite, fadeIn 0.5s ease-in-out;
  letter-spacing: 1px;
  text-transform: uppercase;
}

.relatorio-card b {
  color: #ffea00; /* Destaque neon dourado */
  font-size: 1.6rem; /* ainda maior que o restante */
}

/* Animação do gradiente */
@keyframes gradientFlow {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* Animação de entrada */
@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}

/* Relatório em linha */
.form-relatorio {
  display: flex;
  flex-wrap: wrap;       /* quebra em telas pequenas */
  gap: 1rem;             /* espaçamento entre campos */
  align-items: flex-end; /* alinha labels e selects ao botão */
}

.form-relatorio .form-group {
  flex: 1;               /* cada campo cresce igualmente */
  min-width: 180px;      /* largura mínima para não colapsar */
}

.form-relatorio button {
  padding: .6rem 1.2rem;
  border-radius: .5rem;
  flex-shrink: 0;        /* botão não encolhe */
}

    /* Filtro despesas em linha */
.form-filtro {
  display: flex;
  flex-wrap: wrap;       /* quebra em telas pequenas */
  gap: 1rem;
  align-items: flex-end;
}

.form-filtro .form-group {
  flex: 1;
  min-width: 180px;
}

.form-filtro button {
  padding: .6rem 1.2rem;
  border-radius: .5rem;
  flex-shrink: 0;
}
/* Garante que todos os headers fiquem brancos */
th {
  color: #fff !important;
}



  </style>
</head>
<body>
   <!-- =====<header class="header">
    <h1><i data-lucide="wallet"></i> Bem Vindos aos Controles de Despesas</h1>
  </header>===== -->

  <main class="main">

      <!-- ===== DASHBOARD STATS ===== -->
      <section class="card" style="grid-column: 1 / -1;">
        <h2 class="card-title">
          <i data-lucide="bar-chart-3"></i>
          Dashboard
        </h2>
        <div class="stats-grid" id="statsGrid">
          <div class="stat-card">
            <div class="stat-value" id="totalGastos">R$ 0,00</div>
            <div class="stat-label">Total de Gastos</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalCategorias">0</div>
            <div class="stat-label">Categorias</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="gastosEsteMes">R$ 0,00</div>
            <div class="stat-label">Gastos Este Mês</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="maiorGasto">R$ 0,00</div>
            <div class="stat-label">Maior Gasto</div>
          </div>
        </div>
      </section>



    <!-- Adicionar Despesa -->
    <section class="card">
      <h2 class="card-title"><i data-lucide="plus-circle"></i> Adicionar Despesa</h2>
      <form id="formDespesas" class="form">
        <div class="form-group"><label class="label">Data</label><input type="date" id="data" class="input" required></div>
        <div class="form-group"><label class="label">Categoria</label><select id="categoria" class="select" required></select></div>
        <div class="form-group"><label class="label">Valor</label><input type="number" id="valor" class="input" step="0.01" required></div>
        <div class="form-group"><label class="label">Observação</label><input type="text" id="obs" class="input"></div>
        <div class="form-group"><label class="label">Status</label>
          <select id="pago" class="select"><option value="true">✅ Pago</option><option value="false">⏳ Pendente</option></select>
        </div>
        <button type="submit" class="btn btn-primary"><i data-lucide="plus"></i> Salvar</button>
      </form>
    </section>


    <!-- Relatórios -->
<section class="card">
  <h2 class="card-title"><i data-lucide="file-text"></i> Relatórios</h2>
  <form class="form-relatorio">
    <div class="form-group">
      <label>Categoria</label>
      <select id="relatorioCategoria" class="select"></select>
    </div>
    <div class="form-group">
      <label>Ano</label>
      <select id="relatorioAno" class="select">
        <option value="">Todos</option>
      </select>
    </div>
    <div class="form-group">
      <label>Mês</label>
      <select id="relatorioMes" class="select">
        <option value="">Todos</option>
        <option value="1">Janeiro</option>
        <option value="2">Fevereiro</option>
        <option value="3">Março</option>
        <option value="4">Abril</option>
        <option value="5">Maio</option>
        <option value="6">Junho</option>
        <option value="7">Julho</option>
        <option value="8">Agosto</option>
        <option value="9">Setembro</option>
        <option value="10">Outubro</option>
        <option value="11">Novembro</option>
        <option value="12">Dezembro</option>
      </select>
    </div>
    <button type="button" id="btnRelatorio" class="btn btn-secondary">
      <i data-lucide="search"></i> Gerar
    </button>
  </form>

  <div id="resultadoRelatorio" class="relatorio-card"></div>
</section>





    <!-- Nova Categoria -->
    <section class="card">
      <h2 class="card-title"><i data-lucide="tag"></i> Nova Categoria</h2>
      <form id="formCategorias" class="form">
        <div class="form-group"><input type="text" id="nomeCategoria" class="input" placeholder="Ex: Transporte" required></div>
        <button type="submit" class="btn btn-primary"><i data-lucide="tag"></i> Criar</button>
      </form>
    </section>




    <!-- Gráfico -->
    <section class="card" style="grid-column: 1 / -1;">
      <h2 class="card-title"><i data-lucide="pie-chart"></i> Gastos por Categoria</h2>
      <div class="form-group"><label>Tipo de Gráfico</label>
        <select id="tipoGrafico" class="select"><option value="doughnut">Rosca</option><option value="pie">Pizza</option><option value="bar">Barras</option></select>
      </div>
      <div class="chart-container"><canvas id="graficoGastos"></canvas></div>
    </section>


  <!-- ===== FILTRO DE DESPESAS ===== -->
<section class="card" style="grid-column: 1 / -1;">
  <h2 class="card-title">
    <i data-lucide="filter"></i>
    Filtrar Despesas
  </h2>

  <form id="formFiltro" class="form-filtro">
    <div class="form-group">
      <label class="label" for="filtroCategoria">Categoria:</label>
      <select id="filtroCategoria" class="select">
        <option value="">Todas</option>
      </select>
    </div>

    <div class="form-group">
      <label class="label" for="filtroAno">Ano:</label>
      <select id="filtroAno" class="select">
        <option value="">Todos</option>
      </select>
    </div>

    <div class="form-group">
      <label class="label" for="filtroMes">Mês:</label>
      <select id="filtroMes" class="select">
        <option value="">Todos</option>
        <option value="1">Janeiro</option>
        <option value="2">Fevereiro</option>
        <option value="3">Março</option>
        <option value="4">Abril</option>
        <option value="5">Maio</option>
        <option value="6">Junho</option>
        <option value="7">Julho</option>
        <option value="8">Agosto</option>
        <option value="9">Setembro</option>
        <option value="10">Outubro</option>
        <option value="11">Novembro</option>
        <option value="12">Dezembro</option>
      </select>
    </div>

    <button type="submit" class="btn btn-primary">
      <i data-lucide="search"></i> Buscar
    </button>
  </form>
</section>

    <!-- Lista -->
    <section class="card" style="grid-column: 1 / -1;">
      <h2 class="card-title"><i data-lucide="list"></i> Minhas Despesas</h2>
      <div class="table-container">
        <table><thead><tr><th>Data</th><th>Categoria</th><th>Valor</th><th>Status</th><th>Ações</th></tr></thead>
          <tbody id="listaDespesas"></tbody>
        </table>
      </div>
    </section>
  </main>





<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// === SUPABASE ===
const supabase = createClient(
  "https://dylziaqkyavkfwjepqkp.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5bHppYXFreWF2a2Z3amVwcWtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0NTc1OTgsImV4cCI6MjA2ODAzMzU5OH0.gy5jXxKOTgeCf0Rwq7ktLTz1pyoZ8dJjZOK9UB9rHCM"
);

// === ELEMENTOS ===
const formDespesas = document.getElementById("formDespesas");
const formCategorias = document.getElementById("formCategorias");
const categoriaSelect = document.getElementById("categoria");

const relatorioCategoria = document.getElementById("relatorioCategoria");
const relatorioAno = document.getElementById("relatorioAno");
const relatorioMes = document.getElementById("relatorioMes");
const tipoGraficoSel = document.getElementById("tipoGrafico");

const resultadoRelatorio = document.getElementById("resultadoRelatorio");
const listaDespesas = document.getElementById("listaDespesas");

const filtroCategoria = document.getElementById("filtroCategoria");
const filtroAno = document.getElementById("filtroAno");
const filtroMes = document.getElementById("filtroMes");

let chart = null;
let editandoId = null;

// === HELPERS ===
const BRL = v => new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" }).format(v);
const debounce = (fn, d=200) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), d); }; };
function initIcons(){ if (window.lucide) lucide.createIcons(); }

// === CATEGORIAS ===
async function carregarCategorias() {
  const { data, error } = await supabase.from("tipo_despesas").select("*");
  if (error) { console.error(error); return; }

  const options = data.map(c => `<option value="${c.id}">${c.nome}</option>`).join("");

  if (categoriaSelect) categoriaSelect.innerHTML = '<option value="">Selecione...</option>' + options;
  if (relatorioCategoria) relatorioCategoria.innerHTML = '<option value="">Todas</option>' + options;
  if (filtroCategoria) filtroCategoria.innerHTML = '<option value="">Todas</option>' + options;
}

// === ANOS ===
async function carregarAnos() {
  const { data, error } = await supabase.from("despesas_pessoais").select("data");
  if (error) { console.error("Erro ao carregar anos:", error); return; }

  const anos = [...new Set(data.map(d => d.data?.split("T")[0].slice(0,4)))].sort((a,b)=>b-a);

  if (relatorioAno) {
    relatorioAno.innerHTML = '<option value="">Todos</option>';
    anos.forEach(ano => relatorioAno.insertAdjacentHTML("beforeend", `<option value="${ano}">${ano}</option>`));
  }
  if (filtroAno) {
    filtroAno.innerHTML = '<option value="">Todos</option>';
    anos.forEach(ano => filtroAno.insertAdjacentHTML("beforeend", `<option value="${ano}">${ano}</option>`));
  }
}

// === ESTATÍSTICAS ===
async function carregarEstatisticas() {
  const { data, error } = await supabase.from("despesas_pessoais").select("valor,data");
  if (error) return;

  const total = data.reduce((s, d) => s + d.valor, 0);
  const hoje = new Date();
  const esteMes = data
    .filter(d => {
      const dt = new Date(d.data);
      return dt.getMonth() === hoje.getMonth() && dt.getFullYear() === hoje.getFullYear();
    })
    .reduce((s, d) => s + d.valor, 0);
  const maior = data.length ? Math.max(...data.map(d => d.valor)) : 0;

  document.getElementById("totalGastos").textContent = BRL(total);
  document.getElementById("gastosEsteMes").textContent = BRL(esteMes);
  document.getElementById("maiorGasto").textContent = BRL(maior);

  const { data: cats } = await supabase.from("tipo_despesas").select("*");
  document.getElementById("totalCategorias").textContent = cats?.length || 0;
}

// === RELATÓRIO (texto) ===
document.getElementById("btnRelatorio")?.addEventListener("click", async () => {
  const idCat = relatorioCategoria?.value || "";
  const ano = relatorioAno?.value || "";
  const mes = relatorioMes?.value || "";

  let query = supabase.from("despesas_pessoais").select("valor,data,tipo_despesas(nome)");

  if (idCat) query = query.eq("tipo_id", idCat);
  if (ano) query = query.gte("data", `${ano}-01-01`).lte("data", `${ano}-12-31`);
  if (mes) {
    const a = ano || new Date().getFullYear();
    const m = mes.toString().padStart(2,"0");
    const ultimo = new Date(a, Number(mes), 0).getDate();
    query = query.gte("data", `${a}-${m}-01`).lte("data", `${a}-${m}-${ultimo}`);
  }

  const { data, error } = await query;
  if (error) return;

  const total = data.reduce((s, d) => s + d.valor, 0);
  resultadoRelatorio.innerHTML = `<b>Total:</b> ${BRL(total)} (${data.length} despesas)`;
});

// === GRÁFICO ===
async function montarGrafico() {
  let query = supabase.from("despesas_pessoais").select("valor,data,tipo_id,tipo_despesas(nome)");

  const cat = relatorioCategoria?.value || "";
  const ano = relatorioAno?.value || "";
  const mes = relatorioMes?.value || "";

  if (cat) query = query.eq("tipo_id", cat);
  if (ano) query = query.gte("data", `${ano}-01-01`).lte("data", `${ano}-12-31`);
  if (mes) {
    const a = ano || new Date().getFullYear();
    const m = mes.toString().padStart(2,"0");
    const ultimo = new Date(a, Number(mes), 0).getDate();
    query = query.gte("data", `${a}-${m}-01`).lte("data", `${a}-${m}-${ultimo}`);
  }

  const { data, error } = await query;
  if (error) { console.error("Erro ao carregar gráfico:", error); return; }

  const dataset = {};
  data.forEach(d => {
    const n = d?.tipo_despesas?.nome || "Outros";
    dataset[n] = (dataset[n] || 0) + (Number(d.valor) || 0);
  });

  const labels = Object.keys(dataset);
  const values = Object.values(dataset);

  const ctx = document.getElementById("graficoGastos")?.getContext("2d");
  if (!ctx) return;

  if (chart) chart.destroy();

  const palette = ["#4f46e5","#16a34a","#dc2626","#facc15","#06b6d4","#a855f7","#f97316","#22d3ee","#84cc16","#e11d48"];
  const bg = labels.map((_,i)=> palette[i % palette.length]);

  const tipo = tipoGraficoSel ? tipoGraficoSel.value || "bar" : "bar";

  chart = new Chart(ctx, {
    type: tipo,
    data: {
      labels,
      datasets: [{
        label: "Gastos",
        data: values,
        backgroundColor: bg,
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: tipo !== "bar" ? true : false },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.label}: ${BRL(ctx.parsed)}`
          }
        }
      },
      scales: tipo === "bar" ? {
        y: { beginAtZero: true, ticks: { callback: v => BRL(v) } }
      } : {}
    }
  });
}

// === LISTAR DESPESAS (tabela geral) ===
async function carregarDespesas() {
  const { data, error } = await supabase
    .from("despesas_pessoais")
    .select("id,data,valor,obs,pago,tipo_id,tipo_despesas(nome)")
    .order("data", { ascending: false });
  if (error) return;

  listaDespesas.innerHTML = "";
  data.forEach(d => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.data?.split("T")[0].split("-").reverse().join("/")}</td>
      <td>${d.tipo_despesas?.nome || "—"}</td>
      <td>${BRL(d.valor)}</td>
      <td>${d.pago ? "✅ Pago" : "⏳ Pendente"}</td>
      <td>
        <button class="btn btn-small btn-edit" onclick="editarDespesa(${d.id},'${d.data}',${d.valor},'${(d.obs||"").replace(/'/g,"&#39;")}',${d.pago},${d.tipo_id})">Editar</button>
        <button class="btn btn-small btn-delete" onclick="excluirDespesa(${d.id})">Excluir</button>
      </td>`;
    listaDespesas.appendChild(tr);
  });
}

// === CRUD DESPESAS ===
formDespesas?.addEventListener("submit", async e => {
  e.preventDefault();
  const desp = {
    data: document.getElementById("data").value,
    valor: +document.getElementById("valor").value,
    obs: document.getElementById("obs").value,
    pago: document.getElementById("pago").value === "true",
    tipo_id: +categoriaSelect.value
  };
  let r;
  if (editandoId) {
    r = await supabase.from("despesas_pessoais").update(desp).eq("id", editandoId);
    editandoId = null;
  } else {
    r = await supabase.from("despesas_pessoais").insert([desp]);
  }
  if (r.error) alert(r.error.message);
  else {
    formDespesas.reset();
    await carregarDespesas();
    await carregarEstatisticas();
    await montarGrafico();
  }
});

// === CRUD CATEGORIAS ===
formCategorias?.addEventListener("submit", async e => {
  e.preventDefault();
  const nome = document.getElementById("nomeCategoria").value.trim();
  if (!nome) return;
  const { error } = await supabase.from("tipo_despesas").insert([{ nome }]);
  if (error) alert(error.message);
  else {
    formCategorias.reset();
    await carregarCategorias();
    await montarGrafico(); // atualiza o gráfico depois de nova categoria
  }
});

// === FUNÇÕES GLOBAIS (editar/excluir) ===
window.editarDespesa = (id, data, valor, obs, pago, tipoId) => {
  editandoId = id;
  document.getElementById("data").value = (data||"").split("T")[0];
  document.getElementById("valor").value = valor;
  document.getElementById("obs").value = obs || "";
  document.getElementById("pago").value = pago ? "true" : "false";
  document.getElementById("categoria").value = tipoId;
  window.scrollTo({ top: formDespesas.offsetTop - 100, behavior: "smooth" });
};

window.excluirDespesa = async id => {
  if (confirm("Excluir?")) {
    const { error } = await supabase.from("despesas_pessoais").delete().eq("id", id);
    if (!error) {
      await carregarDespesas();
      await carregarEstatisticas();
      await montarGrafico();
    }
  }
};

// === FILTRO DA TABELA (card "Filtrar Despesas") ===
document.getElementById("formFiltro")?.addEventListener("submit", async e => {
  e.preventDefault();
  const cat = filtroCategoria?.value || "";
  const ano = filtroAno?.value || "";
  const mes = filtroMes?.value || "";

  let query = supabase
    .from("despesas_pessoais")
    .select("id,data,valor,obs,pago,tipo_id,tipo_despesas(nome)")
    .order("data", { ascending: false });

  if (cat) query = query.eq("tipo_id", cat);
  if (ano) query = query.gte("data", `${ano}-01-01`).lte("data", `${ano}-12-31`);
  if (mes) {
    const a = ano || new Date().getFullYear();
    const m = mes.toString().padStart(2,"0");
    const ultimo = new Date(a, Number(mes), 0).getDate();
    query = query.gte("data", `${a}-${m}-01`).lte("data", `${a}-${m}-${ultimo}`);
  }

  const { data, error } = await query;
  if (error) { alert("Erro ao buscar despesas: " + error.message); return; }

  listaDespesas.innerHTML = "";
  if (!data.length) {
    listaDespesas.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:10px;">Nenhuma despesa encontrada</td></tr>`;
    return;
  }
  data.forEach(d => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.data?.split("T")[0].split("-").reverse().join("/")}</td>
      <td>${d.tipo_despesas?.nome || "—"}</td>
      <td>${BRL(d.valor)}</td>
      <td>${d.pago ? "✅ Pago" : "⏳ Pendente"}</td>
      <td>
        <button class="btn btn-small btn-edit" onclick="editarDespesa(${d.id}, '${d.data}', ${d.valor}, '${(d.obs||"").replace(/'/g,"&#39;")}', ${d.pago}, ${d.tipo_id})">Editar</button>
        <button class="btn btn-small btn-delete" onclick="excluirDespesa(${d.id})">Excluir</button>
      </td>`;
    listaDespesas.appendChild(tr);
  });
});

// === LISTENERS PARA ATUALIZAR O GRÁFICO QUANDO OS FILTROS MUDAM ===
const updateGrafico = debounce(montarGrafico, 150);
relatorioAno?.addEventListener("change", updateGrafico);
relatorioCategoria?.addEventListener("change", updateGrafico);
relatorioMes?.addEventListener("change", updateGrafico);
tipoGraficoSel?.addEventListener("change", updateGrafico);

// === INIT ===
document.getElementById("data").value = new Date().toISOString().split("T")[0];

(async () => {
  initIcons();
  await carregarCategorias();
  await carregarAnos();
  await carregarDespesas();
  await carregarEstatisticas();

  // força o tipo inicial para barras
  if (tipoGraficoSel) tipoGraficoSel.value = "bar";
  await montarGrafico();
})();
</script>




</body>
</html>

