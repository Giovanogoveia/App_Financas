<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>App de Despesas Pessoais</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            background: 'hsl(0, 0%, 100%)',
            foreground: 'hsl(240, 10%, 3.9%)',
            primary: {
              DEFAULT: 'hsl(221.2, 83.2%, 53.3%)',
              foreground: 'hsl(210, 40%, 98%)'
            },
            secondary: {
              DEFAULT: 'hsl(210, 40%, 96%)',
              foreground: 'hsl(222.2, 84%, 4.9%)'
            },
            muted: {
              DEFAULT: 'hsl(210, 40%, 96%)',
              foreground: 'hsl(215.4, 16.3%, 46.9%)'
            },
            accent: {
              DEFAULT: 'hsl(210, 40%, 96%)',
              foreground: 'hsl(222.2, 84%, 4.9%)'
            },
            destructive: {
              DEFAULT: 'hsl(0, 84.2%, 60.2%)',
              foreground: 'hsl(210, 40%, 98%)'
            },
            border: 'hsl(214.3, 31.8%, 91.4%)',
            input: 'hsl(214.3, 31.8%, 91.4%)',
            ring: 'hsl(221.2, 83.2%, 53.3%)',
          }
        }
      }
    }
  </script>
  <style>
    /* Custom styles for enhanced UX */
    .form-group {
      position: relative;
      margin-bottom: 1.2rem;
    }
    
    .form-label {
      position: absolute;
      top: 0.6rem;
      left: 0.8rem;
      font-size: 0.875rem;
      color: hsl(215.4, 16.3%, 46.9%);
      transition: all 0.2s ease;
      pointer-events: none;
    }
    
    .form-input:focus + .form-label,
    .form-input:not(:placeholder-shown) + .form-label {
      top: -0.8rem;
      left: 0.4rem;
      font-size: 0.75rem;
      background-color: white;
      padding: 0 0.4rem;
      color: hsl(221.2, 83.2%, 53.3%);
    }
    
    .form-input {
      padding-top: 1.4rem;
      padding-bottom: 0.6rem;
    }
    
    .card-hover {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s, transform 0.3s;
      z-index: 1000;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .toast.success {
      background-color: hsl(142.1, 70.6%, 45.3%);
    }
    
    .toast.error {
      background-color: hsl(0, 84.2%, 60.2%);
    }
  </style>
</head>
<body class="bg-background text-foreground min-h-screen">
  <!-- Toast notification -->
  <div id="toast" class="toast"></div>

  <!-- Header -->
  <header class="bg-gradient-to-r from-primary to-primary/90 text-primary-foreground py-4 px-6 shadow-md sticky top-0 z-50">
    <div class="container mx-auto flex items-center justify-between">
      <h1 class="text-xl font-semibold flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        Controle de Despesas Pessoais
      </h1>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      
      <!-- Card: Adicionar Despesa -->
      <div class="bg-background border border-border rounded-xl p-6 shadow-sm card-hover">
        <h2 class="text-lg font-semibold mb-4 text-primary flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Adicionar Despesa
        </h2>
        <form id="formDespesas" class="space-y-4">
          <div class="form-group">
            <input type="date" id="data" class="form-input w-full border border-input rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-ring" required>
            <label class="form-label">Data</label>
          </div>
          
          <div class="form-group">
            <select id="categoria" class="form-input w-full border border-input rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-ring" required>
              <option value="">Selecione uma categoria</option>
            </select>
            <label class="form-label">Categoria</label>
          </div>
          
          <div class="form-group">
            <input type="number" id="valor" step="0.01" placeholder=" " class="form-input w-full border border-input rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-ring" required>
            <label class="form-label">Valor (R$)</label>
          </div>
          
          <div class="form-group">
            <input type="text" id="obs" placeholder=" " class="form-input w-full border border-input rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-ring">
            <label class="form-label">Observação (opcional)</label>
          </div>
          
          <div class="form-group">
            <select id="pago" class="form-input w-full border border-input rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-ring">
              <option value="true">Sim</option>
              <option value="false">Não</option>
            </select>
            <label class="form-label">Pago</label>
          </div>
          
          <button type="submit" class="w-full bg-primary text-primary-foreground py-2 px-4 rounded-md hover:bg-primary/90 transition font-medium flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Adicionar Despesa
          </button>
        </form>
      </div>

      <!-- Card: Adicionar Categoria -->
      <div class="bg-background border border-border rounded-xl p-6 shadow-sm card-hover">
        <h2 class="text-lg font-semibold mb-4 text-primary flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
          </svg>
          Adicionar Categoria
        </h2>
        <form id="formCategorias" class="space-y-4">
          <div class="form-group">
            <input type="text" id="nomeCategoria" placeholder=" " class="form-input w-full border border-input rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-ring" required>
            <label class="form-label">Nome da Categoria</label>
          </div>
          
          <button type="submit" class="w-full bg-secondary text-secondary-foreground py-2 px-4 rounded-md hover:bg-secondary/80 transition font-medium flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            Adicionar Categoria
          </button>
        </form>
      </div>

      <!-- Card: Relatório -->
      <div class="bg-background border border-border rounded-xl p-6 shadow-sm card-hover">
        <h2 class="text-lg font-semibold mb-4 text-primary flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          Relatório de Gastos
        </h2>
        
        <div class="space-y-4">
          <div class="form-group">
            <select id="relatorioCategoria" class="form-input w-full border border-input rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-ring">
              <option value="">Selecione uma categoria</option>
            </select>
            <label class="form-label">Categoria</label>
          </div>
          
          <div class="form-group">
            <select id="relatorioAno" class="form-input w-full border border-input rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-ring">
              <option value="">Todos os anos</option>
            </select>
            <label class="form-label">Ano</label>
          </div>
          
          <div class="form-group">
            <select id="relatorioMes" class="form-input w-full border border-input rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-ring">
              <option value="">Todos os meses</option>
              <option value="1">Janeiro</option>
              <option value="2">Fevereiro</option>
              <option value="3">Março</option>
              <option value="4">Abril</option>
              <option value="5">Maio</option>
              <option value="6">Junho</option>
              <option value="7">Julho</option>
              <option value="8">Agosto</option>
              <option value="9">Setembro</option>
              <option value="10">Outubro</option>
              <option value="11">Novembro</option>
              <option value="12">Dezembro</option>
            </select>
            <label class="form-label">Mês</label>
          </div>
          
          <button id="btnRelatorio" class="w-full bg-secondary text-secondary-foreground py-2 px-4 rounded-md hover:bg-secondary/80 transition font-medium flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            Gerar Relatório
          </button>
          
          <div id="resultadoRelatorio" class="mt-4 p-3 bg-muted text-muted-foreground rounded-md text-sm"></div>
        </div>
      </div>

      <!-- Card: Gráfico -->
      <div class="bg-background border border-border rounded-xl p-6 shadow-sm card-hover lg:col-span-2">
        <h2 class="text-lg font-semibold mb-4 text-primary flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />
          </svg>
          Distribuição de Gastos
        </h2>
        
        <div class="mb-4">
          <div class="form-group">
            <select id="tipoGrafico" class="form-input w-full border border-input rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-ring">
              <option value="pie">Gráfico de Pizza</option>
              <option value="doughnut">Gráfico de Rosca</option>
              <option value="bar">Gráfico de Barras</option>
            </select>
            <label class="form-label">Tipo de Gráfico</label>
          </div>
        </div>
        
        <div class="h-64 md:h-80">
          <canvas id="graficoGastos"></canvas>
        </div>
        
        <p class="text-sm text-muted-foreground mt-3 text-center">
          Passe o cursor sobre o gráfico para visualizar os valores
        </p>
      </div>
    </div>
  </main>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://dylziaqkyavkfwjepqkp.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5bHppYXFreWF2a2Z3amVwcWtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0NTc1OTgsImV4cCI6MjA2ODAzMzU5OH0.gy5jXxKOTgeCf0Rwq7ktLTz1pyoZ8dJjZOK9UB9rHCM";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const formDespesas = document.getElementById("formDespesas");
    const formCategorias = document.getElementById("formCategorias");
    const categoriaSelect = document.getElementById("categoria");
    const relatorioCategoria = document.getElementById("relatorioCategoria");
    const resultadoRelatorio = document.getElementById("resultadoRelatorio");
    let chart;

    const BRL = (v) => v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});

    // Função para mostrar notificações toast
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      
      setTimeout(() => {
        toast.className = 'toast';
      }, 3000);
    }

    // Carregar categorias
    async function carregarCategorias() {
      const { data, error } = await supabase.from("categorias_despesas_pessoais").select("*").order('nome');
      if (error) { 
        console.error(error); 
        showToast('Erro ao carregar categorias', 'error');
        return; 
      }
      
      categoriaSelect.innerHTML = "<option value=''>Selecione uma categoria</option>";
      relatorioCategoria.innerHTML = "<option value=''>Selecione uma categoria</option>";
      
      data.forEach(c => {
        categoriaSelect.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
        relatorioCategoria.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
      });
    }

    // Carregar anos disponíveis
    async function carregarAnos() {
      const { data, error } = await supabase.from("despesas_pessoais").select("data");
      if (error) { 
        console.error(error); 
        return; 
      }
      
      const anos = [...new Set(data.map(d => new Date(d.data).getFullYear()))].sort((a, b) => b - a);
      const relatorioAno = document.getElementById("relatorioAno");
      relatorioAno.innerHTML = "<option value=''>Todos os anos</option>";
      
      anos.forEach(ano => {
        relatorioAno.innerHTML += `<option value="${ano}">${ano}</option>`;
      });
    }

    // Adicionar categoria
    formCategorias.addEventListener("submit", async (e) => {
      e.preventDefault();
      const nome = document.getElementById("nomeCategoria").value.trim();
      if (!nome) {
        showToast('Digite um nome válido para a categoria', 'error');
        return;
      }
      
      const { error } = await supabase.from("categorias_despesas_pessoais").insert([{ nome }]);
      if (error) {
        showToast('Erro ao adicionar categoria: ' + error.message, 'error');
        return;
      }
      
      formCategorias.reset();
      carregarCategorias();
      showToast('Categoria adicionada com sucesso!');
    });

    // Adicionar despesa
    formDespesas.addEventListener("submit", async (e) => {
      e.preventDefault();
      const categoriaId = Number(document.getElementById("categoria").value);
      if (!categoriaId) {
        showToast('Selecione uma categoria válida!', 'error');
        return;
      }
      
      const despesa = {
        data: document.getElementById("data").value,
        valor: Number(document.getElementById("valor").value),
        obs: document.getElementById("obs").value,
        pago: document.getElementById("pago").value === "true",
        tipo_id: categoriaId
      };
      
      const { error } = await supabase.from("despesas_pessoais").insert([despesa]);
      if (error) {
        showToast('Erro ao adicionar despesa: ' + error.message, 'error');
        return;
      }
      
      formDespesas.reset();
      montarGraficoGeral();
      showToast('Despesa adicionada com sucesso!');
      
      // Recarregar anos caso tenha adicionado um novo ano
      carregarAnos();
    });

    // Relatório com filtros
    document.getElementById("btnRelatorio").addEventListener("click", async () => {
      const idCat = relatorioCategoria.value;
      const ano = document.getElementById("relatorioAno").value;
      const mes = document.getElementById("relatorioMes").value;

      if (!idCat) {
        showToast('Selecione uma categoria!', 'error');
        return;
      }

      let query = supabase
        .from("despesas_pessoais")
        .select("valor, data, tipo_id, categorias_despesas_pessoais ( nome )")
        .eq("tipo_id", idCat)
        .order('data', { ascending: false });

      if (ano) query = query.gte("data", `${ano}-01-01`).lte("data", `${ano}-12-31`);
      if (mes) {
        const mesNum = mes.padStart(2, "0");
        const targetYear = ano || new Date().getFullYear();
        query = query.gte("data", `${targetYear}-${mesNum}-01`)
                     .lte("data", `${targetYear}-${mesNum}-31`);
      }

      const { data, error } = await query;
      if (error) { 
        console.error(error); 
        showToast('Erro ao carregar relatório', 'error');
        return; 
      }

      if (data.length === 0) {
        resultadoRelatorio.innerHTML = `<p class="text-center">Nenhuma despesa encontrada com os filtros selecionados</p>`;
        return;
      }

      const total = data.reduce((s,d) => s + d.valor, 0);
      const nome = data[0]?.categorias_despesas_pessoais?.nome || "Categoria";
      
      let mesTexto = "Todos";
      if (mes) {
        const meses = ["", "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", 
                       "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        mesTexto = meses[parseInt(mes)];
      }

      resultadoRelatorio.innerHTML = `
        <div class="bg-white rounded-lg p-4 shadow">
          <h3 class="font-semibold text-lg mb-2">Relatório de Gastos</h3>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div><span class="font-medium">Categoria:</span> ${nome}</div>
            <div><span class="font-medium">Ano:</span> ${ano || "Todos"}</div>
            <div><span class="font-medium">Mês:</span> ${mesTexto}</div>
            <div><span class="font-medium">Total:</span> <span class="font-bold text-primary">${BRL(total)}</span></div>
          </div>
          <div class="mt-3">
            <span class="font-medium">Nº de Despesas:</span> ${data.length}
          </div>
        </div>
      `;
    });

    // Montar gráfico geral
    async function montarGraficoGeral() {
      const { data, error } = await supabase
        .from("despesas_pessoais")
        .select("valor, categorias_despesas_pessoais ( nome )");
      
      if (error) { 
        console.error(error); 
        showToast('Erro ao carregar dados do gráfico', 'error');
        return; 
      }
      
      const dataset = {};
      data.forEach(d => {
        const nome = d.categorias_despesas_pessoais?.nome || "Outros";
        dataset[nome] = (dataset[nome] || 0) + d.valor;
      });
      
      renderizarGrafico(dataset);
    }

    function renderizarGrafico(dataset) {
      const labels = Object.keys(dataset);
      const values = Object.values(dataset);
      const ctx = document.getElementById("graficoGastos").getContext("2d");
      
      if (chart) chart.destroy();
      
      const tipoSelecionado = document.getElementById("tipoGrafico").value;
      chart = new Chart(ctx, {
        type: tipoSelecionado,
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: [
              "#0b6bff","#28a745","#ffc107","#dc3545","#20c997",
              "#6f42c1","#17a2b8","#fd7e14","#6610f2","#4c6fff",
              "#e83e8c","#6c757d","#fd7e14","#20c997","#0dcaf0"
            ],
            borderWidth: 0,
            borderRadius: tipoSelecionado === "bar" ? 4 : 0,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              cornerRadius: 6,
              callbacks: { 
                label: (ctx) => `${ctx.label}: ${BRL(ctx.parsed)}`,
              }
            },
            legend: { 
              position: "bottom",
              labels: {
                padding: 15,
                usePointStyle: true,
              }
            }
          },
          scales: tipoSelecionado === "bar" ? {
            y: { 
              beginAtZero: true, 
              ticks: { 
                callback: (v) => BRL(v),
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            x: {
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            }
          } : {}
        }
      });
    }

    document.getElementById("tipoGrafico").addEventListener("change", montarGraficoGeral);

    // Inicializar a aplicação
    document.addEventListener('DOMContentLoaded', () => {
      carregarCategorias();
      carregarAnos();
      montarGraficoGeral();
      
      // Definir data atual como padrão
      const hoje = new Date().toISOString().split('T')[0];
      document.getElementById('data').value = hoje;
    });
  </script>
</body>
</html>

